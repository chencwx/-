# Vulnerability_Detection_in_IoT_Firmware_A_Survey

- 标题
- 作者
- 摘要
- I.  引言
- II. 文献综述
- III. 物联网固件漏洞检测的特殊性
- IV. 模糊测试认证绕过物联网嵌入式二进制服务器的缺陷
- V. 结论
- 致谢
- 参考文献

## 标题

Vulnerability_Detection_in_IoT_Firmware_A_Survey，物联网固件漏洞检测综述

## 作者

- Wei Xie, Yikun Jiang, Yong Tang, Yuanming Gao,College of Computer National University of Defense Technology
- Ning Ding,Technician Department Shandong Labor Vocational and Technical College

## 摘要

​    Abstract—With the development of Internet of Things(IoT), more and  more smart  devices are  connected into the Internet. 
The  security  and  privacy  issues  of  IoT  devices  have  received increasingly  academic  and  industrial  attentions.  Vulnerability detection is the key technology to protect IoT devices from **zero-day  attacks.**  However,  traditional  methods  and  tools  of vulnerability detection cannot be directly used in analyzing IoT firmware.  

​    This  paper  firstly  reviews  related  works  on  vulnerability detection in IoT firmware, previous researches are classified into 
four  types  i.e.  **static  analysis,  symbolic  execution,  fuzzing  on emulators and comprehensive testing**. Then, this paper points out that the specificity of vulnerability detection in IoT firmware is to detect logical flaws in embedded binaries which are built on the MIPS architecture. Finally, this paper proposes a method based on  fuzzing  and  static  analysis  to  detect  authentication  bypass flaws in IoT embedded binary servers. The proposed method is proved  to  be  effective  by  verifying  known  CVEs  as  well  as discovering unknown ones. 
Keywords—vulnerability detection; logical flaws; IoT firmware; authentication-bypass 

### 本文综述

- 物联网固件漏洞检测的相关工作的综述
  - 静态分析
  - 符号执行
  - 模糊仿真
  - 综合测试
- 物联网固件漏洞检测的特殊性
- 提出了一种基于模糊和静态分析的物联网嵌入式二进制服务器认证绕过缺陷检测方法
- 对已知cve的验证和对未知cve的发现，证明了该方法的有效性。

### 有关概念

- zero-day  attacks，即“零日漏洞攻击”

  “零日漏洞攻击”又叫“零时差攻击”，也有翻译为“初始攻击”，“瞬时攻击”，即安全补丁与瑕疵曝光的同一日内，相关的恶意程序就出现，并对漏洞进行攻击。

- 静态分析：静态分析指的是一种在不执行程序的情况下对程序行为进行分析的理论、技术。
- 符号执行 （Symbolic Execution）是一种程序分析技术，它可以通过分析程序来得到让特定代码区域执行的输入。顾名思义，使用符号执行分析一个程序时，该程序会使用符号值作为输入，而非一般执行程序时使用的具体值。在达到目标代码时，分析器可以得到相应的路径约束，然后通过约束求解器来得到可以触发目标代码的具体值。即使用符号值代替真实值执行，是当下较为火的方向之一，在软件测试等领域有很好的应用前景

- 模糊仿真：
  - 模糊测试（Fuzzing），是一种通过向目标系统提供非预期的输入并监视异常结果来发现软件漏洞的方法。
  - 仿真器（emulator）是指主要透过硬件或软件使得一台计算机系统（称作主host）在行为上类似于另一台计算机系统（称作客户guest）。与计算机模拟系统（Computer Simulation）的区别在于，仿真器致力于模仿系统的外在表现、行为，而不是模拟系统的抽象模型。计算机模拟是在计算机上执行的数学建模过程，旨在预测现实世界或物理系统的行为或结果。

- 综合测试：一种测试方法，它假定对评估对象的内部结构和实现细节有明确和实质性的了解。也称为白盒测试。

## I.  引言

### 早期的物联网设备安全漏洞研究

- 2010年，崔昂等开发了一种基于nmap的嵌入式设备默认凭据扫描器，支持73种嵌入式设备类型。扫描30亿条ip后，识别出约400万台为嵌入式系统设备，其中54万台为易攻击设备，漏洞率达到13.81%。作者对102,896台易受攻击的嵌入式设备进行了复测，4个月后，约96.75%的易受攻击设备仍处于易受攻击状态。

- 2014年，Mark Patton等人开发了一个框架来做类似的扫描工作。他们使用python脚本，利用Shodan [3] API将监控和数据采集(SCADA)设备选择到数据库中，然后尝试使用默认密码登录以识别易受攻击的系统。结果表明，运行JetDirect打印服务器的HP打印机的漏洞率最高，达到41%。网络摄像头和SCADA设备的漏洞率较低。

### 物联网设备安全漏洞研究现状

- Costin等人基于公开可用的数据，对视频监控、闭路电视和ip摄像头系统中存在的威胁和漏洞进行了系统回顾，并选择了7个标准来描述不同级别的攻击和缓解。然而，该调查并没有关注漏洞检测，只针对监控设备，而不是各种物联网设备。

- Hou等人对嵌入式系统固件的漏洞检测进行了简要综述。他们将现有的固件漏洞检测方法分为模糊测试、行为分析、同源分析和符号执行。然而，仍有一些重要的作品超出了它们的分类。

### 本文主要内容

- 第二章回顾了物联网固件漏洞检测的相关工作。第三章讨论了物联网固件中漏洞检测的难点和特殊性。第四章提出了一种基于模糊和静态分析的有效方法来检测物联网嵌入式二进制服务器的认证绕过缺陷。最后在第五部分，总结结论和未来的工作。

## II. 文献综述

​        近年来，经典的软件分析方法被用于固件漏洞检测。相关著作多在网络和分布式系统安全研讨会、Usenix安全会议等顶级学术会议上发表。然而，传统的方法并不能完全适用于物联网固件的漏洞检测，物联网固件的特殊性还存在许多未解决的问题。相关工作分为:

### 静态分析

​        静态分析是一种不需要在真实设备或仿真器上执行程序就能检测程序漏洞的方法。该方法用于比较不同设备和厂商固件镜像中漏洞的相似性。例如，Costin等提出了一个框架，用于大规模地进行固件收集、过滤、解包和静态分析。他们的工作实现了几种有效的静态分析技术，并引入了一种相关技术，允许将漏洞信息传送到类似的固件镜像。作者从互联网上收集了大约32,356个固件镜像，发现了693个固件镜像受到至少一个漏洞的影响，并报告了38个新的cve。该框架展示了对固件更广大的视图，并帮助研究人员了解已知的漏洞是如何传播的。

### 符号执行

​        符号执行是一种通过计算符号状态而不是实现具体值来分析程序的方法，它能够确定使程序每个部分执行的输入，并且从理论上可能发现程序中的所有漏洞。FIE是一个基于符号执行引擎KLEE的开源工具。针对目前广泛使用的MSP430单片机的固件漏洞进行自动分析。它利用状态拦截和内存涂抹来显著提高代码覆盖率，并支持分析简单固件程序中所有可能路径的能力。FIE支持发现两种类型的错误:内存安全违规和外设误用错误。其局限性为，由于使用KLEE，需要目标固件的源代码，并且需要用户手动验证所有上报的bug。错误配置以及符号执行和本机部署之间的差异会导致不精确性。另外，在引入循环省略和改进的状态选择启发式等技术后，一些缺陷才得以发现。			Firmalice 是第一个在二进制级别工作的固件符号分析系统，不需要在目标设备上进行检测。它建立在Angr[10]之上，这是一个著名的符号执行引擎。它利用一种新的模型来检测身份验证绕过缺陷，比如故意硬编码的凭证、故意隐藏的身份验证接口，以及没有身份验证保护的意外访问点。其局限性在于，为设备提供安全策略时需要手工操作，无法用于大规模分析。此外，恶意固件可能使用混淆来击败静态程序切片，或使用复杂的操作来混淆符号执行。

### 模糊仿真

​		模糊测试被认为是检测传统软件漏洞最有效的方法。它通常需要动态执行上下文来挑战测试目标。不幸的是，有数百万种不同的物联网设备，其中一些可能不提供调试接口。因此，一个能够模拟异构固件的通用仿真器对于模糊物联网固件至关重要。

​		在Black Hat USA 2009大会上，H Bojinov等人提出了一项关于物联网设备嵌入式web接口的扫描工作。他们总共扫描了21款设备，涵盖8个设备类别和16个品牌。他们报告了40多个新的漏洞，并发现了一种名为XCS(跨通道脚本)的新型web漏洞。他们的工作极大地引起了研究人员对物联网设备网络界面安全性的关注。然而，由于使用的是真实设备而不是模拟器，因此它们的扫描是不可扩展的。	

​		Avatar是一个基于事件的仲裁框架，它协调仿真器和物理设备之间的通信。通过在嵌入式设备中注入一个特殊的软件代理，Avatar可以在模拟器中执行固件指令，同时将I/O操作传递给物理硬件。仿真完成后，可以在目标固件上实现模糊等动态分析。实验证明，该算法能够进行逆向工程和漏洞检测，并能发现硬编码的后门。然而，模拟的执行比实际设备上的执行慢得多，而且很难自动模拟外围设备。

​		Firmadyne是一个开源框架，用于大规模分析基于linux的固件。它从互联网上的供应商网站抓取并下载固件镜像。在解压固件映像和提取嵌入式文件系统之后，基于软件的全系统仿真就可以大规模地自动动态分析嵌入式二进制文件。开发者在来自42家设备供应商的23,035个固件映像上评估了该框架。使用成功提取的9486个固件图像上的74个已知漏洞的样本，他们发现，跨越至少89个不同产品的887个固件图像容易受到一个或多个漏洞的攻击，其中包括框架发现的14个新漏洞。但是，该框架无法发现内核或内核模块中的漏洞。因为它是基于通用仿真器的，只有ARM、MIPS和MIPSEL三种标准内核。

### 综合测试

​		有一些工作是使用几种不同的方法一起发现物联网固件中的漏洞。在这些工作中，介绍了其他的动、静态解决方案，提供了综合的结果。

​		Costin等人提出了一种对物联网设备内的嵌入式web接口进行大规模安全分析的新方法。他们设计了一个框架，实现了固件的可扩展和自动化分析。该框架是精确开发的，可以使用纯软件方法和现成的静态和动态分析工具发现嵌入式设备中的漏洞。通过静态分析，在185个固件图像中发现了9271个问题。通过动态分析，发现web界面存在225个高危漏洞。

​		Dai等人提出了一种利用仿真器上的动态模糊和静态污点追踪来定位和利用固件漏洞的方法。作为模糊测试的补充，静态污染跟踪提高了代码覆盖率和动态分析的粒度，有助于高效地生成利用。该方法对路由器、IP摄像头和机顶盒等的漏洞检测是有效的。由于其局限性，一些需要硬件支持的固件镜像无法被仿真器精确模拟。

## III. 物联网固件漏洞检测的特殊性
​		我们通过搜索CVE列表中的关键字来调查不同目标中不同漏洞的比率。根据下方不同目标的不同易受攻击比率表可知，

![](./img/QQ截图20211122191250.png)

Web应用程序(例如。wordpress, phpMyAdmin)和web服务器(例如。Apache)主要受到逻辑缺陷的困扰(例如。XSS，注入，认证旁路)，不会导致系统崩溃。而内存漏洞(例如缓冲区溢出)，经常导致系统崩溃，更有可能被发现在二进制程序和系统(例如。Excel, Linux, Android)。值得注意的是，物联网设备的固件(例如。路由器，相机)有相当比例的逻辑缺陷和内存漏洞。这很大程度上是因为大多数物联网设备的web接口容易被逻辑缺陷所破坏，同时这些接口通常是通过二进制cgi（通用网关接口）而不是脚本实现的（例如PHP, ASP, JSP)。

![](./img/QQ截图20211122194953.png)

​		由上方不同目标的漏洞检测比较图可知，物联网固件漏洞检测与其他目标漏洞检测属于不同象限。在大多数情况下，物联网固件中的漏洞检测旨在发现二进制文件中的逻辑缺陷。然而，目前对这一目标的研究很少。一方面，大多数逻辑缺陷审计工具(例如。RIPS)需要目标的源代码或脚本，但在物联网固件中执行实际操作的cgi只能以二进制文件的形式获得。另一方面，尽管一些模糊仿真(例如AFL)和符号执行(例如S2E)工具支持二进制代码，它们只能通过监控不能由逻辑缺陷引起的系统崩溃来检测内存漏洞。此外，现有的工具甚至无法帮助检测物联网固件中的内存漏洞，因为许多嵌入式二进制文件是基于MIPS架构，而不是传统软件中常用的x86架构。实际上，很少有现有的工具支持MIPS体系结构。

## IV.模糊测试认证绕过物联网嵌入式二进制服务器的缺陷
​		上图所示物联网固件中认证绕过缺陷的百分比明显高于其他目标。检测物联网固件中的认证绕过缺陷是发现嵌入式二进制文件中的逻辑缺陷的一个典型例子。

​		Firmalice已经被提出用于自动检测二进制固件中的认证绕过缺陷。然而，它是基于符号执行的，这对于非专业用户来说是复杂的。而且，如果没有在真实设备上或至少在虚拟模拟器上的实际执行，它无法最终确认可疑的缺陷。

​		本文提出了一种将模糊测试与静态分析相结合的方法，用于检测和验证物联网中嵌入二进制服务器的认证绕过缺陷。所提出的方法如下方用于检测物联网嵌入式二进制服务器中的认证绕过缺陷方法图所示。

![](./img/QQ截图20211122200517.png)

首先，静态分析器从目标二进制web服务器中提取所有字符串，并输出带有参数位置的关键字列表。然后，漏洞检测工具使用关键字和相应的参数位置创建并发送一系列的数据包作为测试用例。最后，漏洞检查工具检查测试请求的相应响应，以验证是否触发了认证绕过缺陷。它的原理非常简单:所有触发身份验证绕过缺陷的关键字都被认为包含在目标二进制文件中，而且在大多数情况下，这些关键字都是没有加密的明文字符串形式。

​		通过对一些已知的认证绕过缺陷进行验证，证明了该方法的有效性。

### 没有身份验证保护的cgi

​		在嵌入式web服务器中，一些cgi甚至可以被未经身份验证的用户访问。然而，一些易受攻击的cgi可能既没有单独的二进制文件，也无法被网络爬虫从任何网页上抓取。因此，这些易受攻击的cgi不能被传统的模糊测试器注意到。该方法对无认证保护的cgi发现是有效的。例如，CVE-2017-5521报告说，输出管理员密码的"  passworrecover .cgi "在一系列netgear路由器中无需认证即可访问。虽然在易受攻击的固件中没有一个名为“passworrecovery .  cgi”的二进制文件，但通过静态分析嵌入式二进制web服务器“/usr/sbin/httpd”，该分析器可以找到易受攻击的CGI的名称作为关键字。然后，通过检查CGI响应的状态码不是“401  unauthorized”而是“200  OK”，fuzzer很容易发现认证绕过缺陷。

​		[参考链接](https://www.freesion.com/article/2339628744/)

### 复杂后门

​		一些物联网设备有后门，可以让未经认证的用户远程执行系统命令。一些后门是由设备开发人员创建的，以简化调试测试，而其他一些后门是有意为恶意目的精心设计的。

​		我们的方法对发现后门也很有效。例如CVE-2013-6026，在一系列D-link路由器中阐述了一个后门。一旦攻击者将user-agent头设置为“xmlset_roodkcableoj28840ybtide”，所有没有身份验证的HTTP请求都是可用的。计算机模糊器很难理解语义字符串“xmlset_roodkcableoj28840ybtide”，这意味着“由04882  joel  backdoor编辑”的倒序。然而，我们的分析器可以从嵌入式二进制web服务器“/bin/web”中提取触发器字符串作为关键字。然后我们的漏洞检测工具可以在发送一个具有复杂用户代理头的测试用例时发现认证绕过缺陷。

​		该方法也被证明是有效的发现未知的新缺陷（例如零日漏洞)。然而，在供应商修复发现的缺陷之前，发布细节是不合适的。

​		[参考链接](https://nvd.nist.gov/vuln/detail/CVE-2013-6026)

## V. 结论

### 本文的主要内容和贡献包括:

- 将物联网固件漏洞检测的相关工作分为静态分析、符号执行、仿真器模糊和综合测试4类。
- 指出物联网固件漏洞检测的特殊性。它是用来检测建立在MIPS架构上的嵌入式二进制文件中的逻辑缺陷。
- 提出了一种基于模糊和静态分析的方法来检测物联网嵌入式二进制服务器中的认证绕过缺陷。通过对已知cve的验证，证明了该方法的有效性。

### 未来的工作

- 通过使用机器学习方法改进所提出的静态分析器，为模糊器创建更精确的关键字。

- 将该方法大规模应用于各种物联网固件。